---
phase: 01-runtime-guardrails-and-ipc-backbone
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - src/preload/runtime-status-bridge.ts
  - src/preload/index.ts
  - src/renderer/runtime-status/runtime-state-machine.ts
  - src/renderer/runtime-status/RuntimeRecoveryBanner.tsx
  - src/renderer/runtime-status/MismatchRecoveryPanel.tsx
  - src/renderer/app/AppShell.tsx
autonomous: true
must_haves:
  truths:
    - "During active voice disruption, user sees a non-blocking 'Reconnecting...' indicator."
    - "If recovery succeeds quickly, disruption UI clears without noisy success messaging."
    - "If recovery remains unavailable after retries, user sees one-sentence non-technical next-step guidance that emphasizes 'Restart app' with a 'Show details' path."
    - "Version mismatch copy is human-first, with expected vs installed versions in Details and Copy report action."
  artifacts:
    - path: "src/renderer/runtime-status/runtime-state-machine.ts"
      provides: "Timed status-to-copy mapping for transient, delayed, and action states"
      contains: "3000"
    - path: "src/renderer/runtime-status/RuntimeRecoveryBanner.tsx"
      provides: "Non-blocking recovery banner for active voice use"
      contains: "Reconnecting..."
    - path: "src/renderer/runtime-status/MismatchRecoveryPanel.tsx"
      provides: "Human summary, Details expander, and Copy report for mismatch"
      contains: "Copy report"
  key_links:
    - from: "src/preload/runtime-status-bridge.ts"
      to: "src/main/ipc/runtime-controller.ts"
      via: "invoke/subscription bridge for runtime status"
      pattern: "runtime:get-status"
    - from: "src/renderer/runtime-status/runtime-state-machine.ts"
      to: "src/renderer/runtime-status/RuntimeRecoveryBanner.tsx"
      via: "maps backend state/timers to approved human copy"
      pattern: "Taking longer than usual|Still starting"
    - from: "src/renderer/runtime-status/MismatchRecoveryPanel.tsx"
      to: "src/preload/runtime-status-bridge.ts"
      via: "panel actions call preload runtime recovery APIs for fix/retry/restart/copy report"
      pattern: "fixNow|tryAgain|restartApp|copyReport"
    - from: "src/preload/runtime-status-bridge.ts"
      to: "src/main/ipc/runtime-controller.ts"
      via: "recovery action invokes route to main handlers for fix/retry/restart/copy report"
      pattern: "runtime:fix-now|runtime:retry|runtime:restart-app|runtime:copy-report"
---

<objective>
Deliver user-facing recovery and mismatch UX that strictly follows the locked tone and action guidance.

Purpose: Turn backend lifecycle states into calm, actionable user feedback without exposing internal jargon.
Output: Runtime disruption banner/panels, delayed-state messaging, and mismatch details/copy-report flow.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-CONTEXT.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-RESEARCH.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expose runtime status to renderer through narrow preload bridge</name>
  <files>src/preload/runtime-status-bridge.ts, src/preload/index.ts</files>
  <action>Create preload APIs for status snapshot + updates + actions (`Try again`, `Restart app`, `Copy report`) with sender-safe, scoped methods only. Keep implementation async and avoid exposing raw IPC objects.</action>
  <verify>npm run test -- src/preload/runtime-status-bridge.test.ts</verify>
  <done>Renderer consumes runtime status/action APIs via preload without direct ipcRenderer access.</done>
</task>

<task type="auto">
  <name>Task 2: Implement recovery state machine with locked timing and human-tone copy</name>
  <files>src/renderer/runtime-status/runtime-state-machine.ts, src/renderer/runtime-status/RuntimeRecoveryBanner.tsx, src/renderer/app/AppShell.tsx</files>
  <action>Map backend statuses to user-facing copy using locked tone rules: short 2-5 word transients, one gentle delayed update around ~3s, and first actionable UI around ~8-10s with `Try again` and `Restart app`. Add explicit exhausted-recovery behavior after configured auto-retry attempts fail: show one-sentence non-technical next-step summary that emphasizes `Restart app` and includes a `Show details` path with expandable technical details. Do not use internal terms (worker/daemon/service/engine/recovering) in primary copy. Keep banner non-blocking and only visible during active voice disruptions.</action>
  <verify>npm run test -- src/renderer/runtime-status/runtime-state-machine.test.ts</verify>
  <done>UI shows calm staged messaging and correct actions by state: timed disruptions show `Try again` + `Restart app`, exhausted recovery emphasizes `Restart app` + `Show details` with a non-technical one-line summary.</done>
</task>

<task type="auto">
  <name>Task 3: Add mismatch guidance panel with recommended-path-first behavior</name>
  <files>src/renderer/runtime-status/MismatchRecoveryPanel.tsx, src/renderer/runtime-status/runtime-state-machine.ts</files>
  <action>Implement mismatch UX exactly per locked decisions: human one-sentence summary first, automatic in-place fix path first (`Fix now`), fallback `Restart app` only when relevant, details expander for expected vs installed versions, and `Copy report`. Do not include deferred `Report issue` action.</action>
  <verify>npm run test -- src/renderer/runtime-status/MismatchRecoveryPanel.test.tsx</verify>
  <done>Mismatch flow presents one recommended recovery path first and keeps technical detail behind Details.</done>
</task>

</tasks>

<verification>
Run renderer runtime-status tests and manual smoke run to confirm copy/timing/action behavior matches locked decisions.
</verification>

<success_criteria>
Recovery and mismatch states are understandable and actionable for users without infrastructure jargon.
</success_criteria>

<output>
After completion, create `.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-03-SUMMARY.md`
</output>
