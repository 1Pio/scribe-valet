---
phase: 01-runtime-guardrails-and-ipc-backbone
plan: 07
type: execute
wave: 5
depends_on:
  - 01-03
  - 01-06
files_modified:
  - src/main/index.ts
  - src/main/ipc/runtime-controller.ts
  - src/main/ipc/runtime-controller.test.ts
  - src/preload/runtime-status-bridge.ts
  - src/preload/runtime-status-bridge.test.ts
  - src/renderer/app/AppShell.tsx
  - .planning/phases/01-runtime-guardrails-and-ipc-backbone/01-UAT.md
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "When worker protocol/version is incompatible and user clicks Restart app, the application relaunches instead of only refreshing worker state."
    - "Fix now and Try again remain in-place supervisor recovery actions and do not relaunch the application process."
    - "After choosing Restart app from mismatch recovery, the app comes back through normal startup rather than staying in the same in-place recovery session."
  artifacts:
    - path: "src/main/index.ts"
      provides: "Dedicated app relaunch behavior for restart-app action"
      contains: "app.relaunch"
    - path: "src/preload/runtime-status-bridge.ts"
      provides: "Restart-app bridge contract with relaunch-intent payload validation"
      contains: "restartApp"
    - path: "src/main/ipc/runtime-controller.test.ts"
      provides: "Runtime restart action coverage proving distinct restart-app contract"
      contains: "RUNTIME_CONTROLLER_CHANNELS.RESTART_APP"
  key_links:
    - from: "src/renderer/app/AppShell.tsx"
      to: "src/preload/runtime-status-bridge.ts"
      via: "Restart app button invokes runtimeStatusBridge.restartApp() without expecting RuntimeStatus mutation"
      pattern: "onRestartApp|restartApp\(\)"
    - from: "src/preload/runtime-status-bridge.ts"
      to: "src/main/ipc/runtime-controller.ts"
      via: "IPC invoke for runtime:restart-app validates relaunch-intent payload"
      pattern: "RUNTIME_RESTART_APP"
    - from: "src/main/ipc/runtime-controller.ts"
      to: "src/main/index.ts"
      via: "restartApp action dispatches dedicated relaunch handler, not restartSupervisor"
      pattern: "restartApp"
---

<objective>
Close the diagnosed UAT gap where `Restart app` in mismatch recovery only refreshes supervisor state and does not relaunch Electron.

Purpose: Ensure mismatch fallback behavior matches user expectations and locked Phase 1 recovery guidance.
Output: True relaunch behavior on `runtime:restart-app`, separated action semantics for retry/fix-now, and updated UAT evidence removing the diagnosed gap.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-CONTEXT.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-UAT.md
@.planning/debug/restart-app-action-not-restarting.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-03-SUMMARY.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement true app relaunch semantics for runtime:restart-app in main</name>
  <files>src/main/index.ts, src/main/ipc/runtime-controller.ts</files>
  <action>Add a dedicated restart-app action path in main that uses Electron relaunch semantics (`app.relaunch()` with controlled exit) instead of `restartSupervisor(supervisor)`. Keep `fix-now` and `retry` mapped to supervisor restart exactly as-is. Update runtime-controller action typing/contracts so `restartApp` is modeled as relaunch intent (not RuntimeStatus refresh), because the diagnosed gap root cause is channel-level semantic conflation between retry and restart-app.</action>
  <verify>npm run test -- src/main/ipc/runtime-controller.test.ts</verify>
  <done>`runtime:restart-app` no longer routes through supervisor reset and now triggers app relaunch intent while preserving existing retry/fix-now behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Update preload and renderer restart-app contract to match relaunch intent</name>
  <files>src/preload/runtime-status-bridge.ts, src/preload/runtime-status-bridge.test.ts, src/renderer/app/AppShell.tsx, src/main/ipc/runtime-controller.test.ts</files>
  <action>Change `restartApp()` bridge contract from `Promise&lt;RuntimeStatus&gt;` to a relaunch-intent acknowledgment payload and validate it with a strict type guard in preload. Update `AppShell` restart handlers so they invoke restart and do not treat the response as a new in-place runtime status snapshot. Extend tests to assert restart-app channel invocation and payload validation, and to prove runtime-controller restart action has its own contract path. Do not alter mismatch copy hierarchy, and do not add deferred `Report issue` functionality.</action>
  <verify>npm run test -- src/preload/runtime-status-bridge.test.ts src/main/ipc/runtime-controller.test.ts src/renderer/runtime-status/MismatchRecoveryPanel.test.tsx</verify>
  <done>Renderer/preload restart behavior aligns with true relaunch semantics and test coverage enforces the non-`RuntimeStatus` restart-app contract.</done>
</task>

<task type="auto">
  <name>Task 3: Re-run focused regression checks and update UAT diagnosis to closed</name>
  <files>.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-UAT.md</files>
  <action>Run the phase recheck command set relevant to restart/mismatch behavior and update UAT Test 3 plus Gaps so the diagnosed restart-app issue is closed with concrete evidence. Keep scope limited to the diagnosed gap; do not reopen unrelated skipped checks beyond documenting their unchanged status.</action>
  <verify>npm run validate:runtime && npm run test -- src/main/ipc/runtime-controller.test.ts src/preload/runtime-status-bridge.test.ts src/renderer/runtime-status/runtime-state-machine.test.ts src/renderer/runtime-status/MismatchRecoveryPanel.test.tsx</verify>
  <done>`01-UAT.md` no longer records the restart-app relaunch mismatch as an open diagnosed gap.</done>
</task>

</tasks>

<verification>
Confirm `runtime:restart-app` uses app relaunch semantics, verify retry/fix-now still perform supervisor restart, and confirm updated UAT no longer lists Test 3 as failed.
</verification>

<success_criteria>
The only diagnosed UAT gap is closed: mismatch recovery still appears as before, and `Restart app` now reflects true relaunch intent end-to-end across main, preload, and renderer contracts.
</success_criteria>

<output>
After completion, create `.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-07-SUMMARY.md`
</output>
