---
phase: 01-runtime-guardrails-and-ipc-backbone
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/main/supervisor/worker-supervisor.ts
  - src/main/supervisor/retry-policy.ts
  - src/main/supervisor/handshake-gate.ts
  - src/main/ipc/runtime-controller.ts
  - src/worker/index.ts
  - src/shared/types/runtime-status.ts
autonomous: true
must_haves:
  truths:
    - "If runtime processing crashes, the app reconnects automatically without relaunch."
    - "Recovery retries follow three short backoff attempts before showing next steps."
    - "Handshake/version mismatches are rejected with explicit recovery state instead of undefined behavior."
  artifacts:
    - path: "src/main/supervisor/worker-supervisor.ts"
      provides: "Main-owned worker spawn/restart lifecycle"
      contains: "attempt"
    - path: "src/main/supervisor/handshake-gate.ts"
      provides: "Protocol and semver compatibility acceptance gate"
      contains: "semver"
    - path: "src/shared/types/runtime-status.ts"
      provides: "Status model for reconnect, mismatch, and failure states"
      contains: "reconnecting"
  key_links:
    - from: "src/main/supervisor/worker-supervisor.ts"
      to: "src/worker/index.ts"
      via: "utilityProcess startup and handshake request"
      pattern: "utilityProcess\.fork"
    - from: "src/main/supervisor/handshake-gate.ts"
      to: "src/main/supervisor/worker-supervisor.ts"
      via: "gates job readiness on successful compatibility check"
      pattern: "acceptHandshake"
---

<objective>
Implement deterministic worker lifecycle control: handshake gate, semver validation, crash recovery retries, and runtime status publication.

Purpose: Deliver ARCH-02 resilience and compatibility guardrails before user-facing messaging is layered on top.
Output: Main-owned supervisor with automatic restart/reconnect and explicit mismatch/failure states.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-CONTEXT.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-RESEARCH.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build main-owned worker supervisor with restart policy</name>
  <files>src/main/supervisor/worker-supervisor.ts, src/main/supervisor/retry-policy.ts, src/worker/index.ts</files>
  <action>Implement worker lifecycle orchestration in main process using utility process APIs and crash/exit listeners. Apply locked retry policy exactly: 3 automatic attempts with short backoff around 0.2s, 0.8s, and 2s. Keep early recovery quiet by default and emit status transitions for UI mapping in later plans.</action>
  <verify>npm run test -- src/main/supervisor/retry-policy.test.ts</verify>
  <done>Crash simulation triggers automatic reconnect attempts with configured backoff and stops after third failed attempt.</done>
</task>

<task type="auto">
  <name>Task 2: Gate readiness on protocol and version handshake</name>
  <files>src/main/supervisor/handshake-gate.ts, src/main/supervisor/worker-supervisor.ts, src/shared/protocol/handshake.ts</files>
  <action>Use semver-based compatibility checks for handshake acceptance. Reject mismatched protocol/version combinations before any work dispatch, and emit explicit mismatch diagnostics including expected and installed versions for downstream Details/Copy report UI. Do not use string version comparison.</action>
  <verify>npm run test -- src/main/supervisor/handshake-gate.test.ts</verify>
  <done>Only compatible handshake combinations are marked ready; mismatches produce structured rejection payloads.</done>
</task>

<task type="auto">
  <name>Task 3: Publish normalized runtime status stream for renderer consumers</name>
  <files>src/main/ipc/runtime-controller.ts, src/shared/types/runtime-status.ts, src/main/supervisor/worker-supervisor.ts</files>
  <action>Create IPC endpoints/events that expose current lifecycle status and latest recovery context to renderer (idle, reconnecting, delayed, mismatch, exhausted). Include timing metadata so later UI can show delayed copy around ~3s and first action UI around ~8-10s while keeping technical data hidden by default.</action>
  <verify>npm run test -- src/main/ipc/runtime-controller.test.ts</verify>
  <done>Renderer-facing runtime status API returns stable typed states reflecting real supervisor transitions.</done>
</task>

</tasks>

<verification>
Run supervisor tests and a crash simulation command to confirm automatic recovery and deterministic mismatch rejection.
</verification>

<success_criteria>
ARCH-02 backend mechanics are complete: recovery is automatic and compatibility is enforced before work begins.
</success_criteria>

<output>
After completion, create `.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-02-SUMMARY.md`
</output>
