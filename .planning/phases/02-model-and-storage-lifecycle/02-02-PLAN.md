---
phase: 02-model-and-storage-lifecycle
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/model-lifecycle/model-manifest.ts
  - src/main/model-lifecycle/integrity.ts
  - src/main/model-lifecycle/download-resume-store.ts
  - src/main/model-lifecycle/download-resume-store.test.ts
  - src/main/model-lifecycle/artifact-installer.ts
  - src/main/model-lifecycle/artifact-installer.test.ts
autonomous: true
must_haves:
  truths:
    - "Missing artifacts download once, verify integrity, and only then become active files."
    - "Interrupted model downloads resume automatically on next launch when validator checks permit range resume."
    - "Verification failures are diagnosable and never silently promote corrupted artifacts."
  artifacts:
    - path: "src/main/model-lifecycle/artifact-installer.ts"
      provides: "Stage -> verify -> promote install pipeline"
    - path: "src/main/model-lifecycle/download-resume-store.ts"
      provides: "Persistent partial-download metadata for launch-to-launch resume"
    - path: "src/main/model-lifecycle/model-manifest.ts"
      provides: "Required model bundle definition with user-friendly display names"
  key_links:
    - from: "src/main/model-lifecycle/artifact-installer.ts"
      to: "src/main/model-lifecycle/integrity.ts"
      via: "hash staged file before promote"
      pattern: "verify|sha256|checksum"
    - from: "src/main/model-lifecycle/artifact-installer.ts"
      to: "src/main/model-lifecycle/download-resume-store.ts"
      via: "persist and consume resume metadata with validators"
      pattern: "Range|If-Range|resume"
---

<objective>
Implement robust artifact install mechanics so model assets can be downloaded, resumed, verified, and promoted atomically.

Purpose: Satisfy MODL-02 reliability core while preventing corrupted or duplicated model installs.
Output: Manifest-driven artifact installer, integrity helpers, and resume metadata store with targeted tests.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-model-and-storage-lifecycle/02-CONTEXT.md
@.planning/phases/02-model-and-storage-lifecycle/02-RESEARCH.md
@.planning/phases/01-runtime-guardrails-and-ipc-backbone/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define required model bundle manifest and artifact descriptors</name>
  <files>src/main/model-lifecycle/model-manifest.ts</files>
  <action>Create a manifest module that declares required artifacts for STT/LLM/TTS with stable IDs, user-friendly names for UI headings/progress lines, expected byte size, and checksum metadata. Keep selection scope fixed to required bundle only (no rich model-group management in this phase).</action>
  <verify>npm run build</verify>
  <done>Manifest exports a deterministic required bundle contract used by installer and UI projection, with names suitable for "Downloading AI models" style messaging.</done>
</task>

<task type="auto">
  <name>Task 2: Build stage-verify-promote installer with resume-aware range semantics</name>
  <files>src/main/model-lifecycle/artifact-installer.ts, src/main/model-lifecycle/integrity.ts, src/main/model-lifecycle/download-resume-store.ts</files>
  <action>Implement artifact install flow that writes to staged `.partial` paths, supports resume via `Range` + validator-aware `If-Range`, falls back to full restart when validator mismatch or `200` full response occurs, verifies SHA-256 before promote, and renames atomically into final location. Persist and clear resume metadata per artifact lifecycle so interrupted downloads automatically continue on next launch.</action>
  <verify>npm run test -- src/main/model-lifecycle/artifact-installer.test.ts src/main/model-lifecycle/download-resume-store.test.ts</verify>
  <done>Installer can complete fresh and resumed downloads, never promotes failed checksum artifacts, and leaves deterministic diagnostics for failure cases.</done>
</task>

<task type="auto">
  <name>Task 3: Add focused test coverage for resume and integrity edge cases</name>
  <files>src/main/model-lifecycle/artifact-installer.test.ts, src/main/model-lifecycle/download-resume-store.test.ts</files>
  <action>Add tests for: interrupted download resume on relaunch, validator mismatch forcing full redownload, checksum mismatch rejecting promote, successful promote clearing partial metadata, and deterministic failure classification hints consumed by retry policy in later plan.</action>
  <verify>npm run test -- src/main/model-lifecycle/artifact-installer.test.ts src/main/model-lifecycle/download-resume-store.test.ts</verify>
  <done>Test suite demonstrates reliable resume behavior and integrity-first install guarantees across interruption and corruption scenarios.</done>
</task>

</tasks>

<verification>
Run targeted installer tests, then run `npm run build` to ensure new lifecycle modules compile and export cleanly for orchestration wiring.
</verification>

<success_criteria>
MODL-02 download/install backbone exists with one-time artifact acquisition, validator-aware resume, and atomic integrity-verified promotion.
</success_criteria>

<output>
After completion, create `.planning/phases/02-model-and-storage-lifecycle/02-model-and-storage-lifecycle-02-SUMMARY.md`
</output>
