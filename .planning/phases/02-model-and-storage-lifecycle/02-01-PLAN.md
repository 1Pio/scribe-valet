---
phase: 02-model-and-storage-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/types/storage-config.ts
  - src/main/storage/storage-paths.ts
  - src/main/storage/storage-paths.test.ts
  - src/main/storage/path-override-store.ts
  - src/main/storage/path-override-store.test.ts
autonomous: true
must_haves:
  truths:
    - "Startup reports whether required model files exist in the configured model directory."
    - "Storage roots are separated by category and can be overridden predictably."
    - "Missing directories entered by user can be created during path updates."
  artifacts:
    - path: "src/main/storage/storage-paths.ts"
      provides: "OS default roots plus hybrid shared-root/per-category override resolution"
    - path: "src/main/storage/path-override-store.ts"
      provides: "Persistent override read/write for startup and settings reuse"
    - path: "src/shared/types/storage-config.ts"
      provides: "Typed storage category and override DTOs shared across process boundaries"
  key_links:
    - from: "src/main/storage/path-override-store.ts"
      to: "src/main/storage/storage-paths.ts"
      via: "load persisted override before resolving active roots"
      pattern: "load.*override|resolve.*storage"
    - from: "src/main/storage/storage-paths.ts"
      to: "electron.app.getPath"
      via: "derive OS defaults for config, logs, tools, models"
      pattern: "app\.getPath"
---

<objective>
Build deterministic storage root resolution and override persistence so model lifecycle logic can rely on one canonical path source.

Purpose: Satisfy MODL-03 foundation with separated directories, OS defaults, and safe user override behavior.
Output: Typed storage config contracts, main-process path resolver, and persisted hybrid override store with tests.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-model-and-storage-lifecycle/02-CONTEXT.md
@.planning/phases/02-model-and-storage-lifecycle/02-RESEARCH.md
@src/main/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define typed storage topology and override contracts</name>
  <files>src/shared/types/storage-config.ts</files>
  <action>Create shared types for storage categories (`models`, `config`, `tools`, `logs`), default root snapshot, and hybrid override payload (`customRoot` + optional per-category overrides). Include a normalized "active paths" DTO that downstream lifecycle/UI layers can consume without duplicating path logic.</action>
  <verify>npm run build</verify>
  <done>TypeScript exports compile and can represent OS defaults, shared-root override, and per-category override in one schema.</done>
</task>

<task type="auto">
  <name>Task 2: Implement main-process storage path resolver with safe directory provisioning</name>
  <files>src/main/storage/storage-paths.ts, src/main/storage/path-override-store.ts</files>
  <action>Implement storage root resolution using Electron defaults (`app.getPath`) and apply hybrid override policy from persisted config. Ensure path changes pre-create missing directories via `mkdir(..., { recursive: true })`, then return active-path summary with only active values (not all candidates). Keep onboarding-first flows out of scope and do not add rich model-group selectors.</action>
  <verify>npm run test -- src/main/storage/storage-paths.test.ts src/main/storage/path-override-store.test.ts</verify>
  <done>Resolver returns separated active directories for models/config/tools/logs, supports shared custom root with optional per-category overrides, and can create missing entered directories during update flow.</done>
</task>

<task type="auto">
  <name>Task 3: Add focused storage override tests for regression safety</name>
  <files>src/main/storage/storage-paths.test.ts, src/main/storage/path-override-store.test.ts</files>
  <action>Add tests that prove: OS defaults are used when no override exists; custom root fans out to all categories by default; per-category override takes precedence; missing override directory is created before applying; serialized overrides round-trip without path loss.</action>
  <verify>npm run test -- src/main/storage/storage-paths.test.ts src/main/storage/path-override-store.test.ts</verify>
  <done>All storage override tests pass and cover default, hybrid override, and directory-creation behavior.</done>
</task>

</tasks>

<verification>
Run `npm run test -- src/main/storage/storage-paths.test.ts src/main/storage/path-override-store.test.ts` and confirm green results; run `npm run build` to verify shared type exports and main-process modules compile together.
</verification>

<success_criteria>
MODL-03 storage foundation exists with typed separated directories, OS defaults, and hybrid override persistence that can be consumed by startup and settings flows.
</success_criteria>

<output>
After completion, create `.planning/phases/02-model-and-storage-lifecycle/02-model-and-storage-lifecycle-01-SUMMARY.md`
</output>
