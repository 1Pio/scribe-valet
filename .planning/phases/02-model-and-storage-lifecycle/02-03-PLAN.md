---
phase: 02-model-and-storage-lifecycle
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/shared/types/model-lifecycle.ts
  - src/shared/protocol/ipc-envelope.ts
  - src/main/model-lifecycle/model-lifecycle-service.ts
  - src/main/model-lifecycle/model-lifecycle-service.test.ts
  - src/main/ipc/model-lifecycle-controller.ts
  - src/main/ipc/model-lifecycle-controller.test.ts
  - src/preload/model-lifecycle-bridge.ts
  - src/preload/model-lifecycle-bridge.test.ts
  - src/preload/index.ts
  - src/main/index.ts
autonomous: true
must_haves:
  truths:
    - "At startup, readiness state is computed in main process and exposed to renderer with live updates."
    - "If model types are partially unavailable, capabilities degrade by mode (Assistant blocked, Dictation available when STT is healthy with raw-output notice)."
    - "Download/verification failures auto-retry safely and then expose explicit recovery actions with diagnostics."
  artifacts:
    - path: "src/main/model-lifecycle/model-lifecycle-service.ts"
      provides: "Main-process source-of-truth startup checks, install orchestration, and retry policy"
    - path: "src/main/ipc/model-lifecycle-controller.ts"
      provides: "IPC handlers/events for readiness snapshots and recovery actions"
    - path: "src/preload/model-lifecycle-bridge.ts"
      provides: "Validated renderer bridge for lifecycle status and actions"
    - path: "src/shared/types/model-lifecycle.ts"
      provides: "Shared DTOs for startup steps, readiness reports, and mode availability"
  key_links:
    - from: "src/main/model-lifecycle/model-lifecycle-service.ts"
      to: "src/main/model-lifecycle/artifact-installer.ts"
      via: "orchestrate missing artifact install and verification"
      pattern: "install|verify|artifact"
    - from: "src/main/ipc/model-lifecycle-controller.ts"
      to: "src/preload/model-lifecycle-bridge.ts"
      via: "invoke/on channels with payload validation"
      pattern: "model-lifecycle"
    - from: "src/main/model-lifecycle/model-lifecycle-service.ts"
      to: "src/main/storage/storage-paths.ts"
      via: "resolve active model path before readiness checks"
      pattern: "storage|path"
---

<objective>
Create the runtime orchestration layer and process boundaries that make lifecycle state actionable in the app.

Purpose: Satisfy MODL-01 and MODL-02 behavioral wiring with main-owned readiness computation, retries, and renderer-safe access.
Output: Shared lifecycle state contracts, main lifecycle service, IPC controller, preload bridge, and bootstrap wiring with tests.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-model-and-storage-lifecycle/02-CONTEXT.md
@.planning/phases/02-model-and-storage-lifecycle/02-RESEARCH.md
@src/main/ipc/runtime-controller.ts
@src/preload/runtime-status-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define shared lifecycle state model and IPC channels</name>
  <files>src/shared/types/model-lifecycle.ts, src/shared/protocol/ipc-envelope.ts</files>
  <action>Add typed readiness/checklist/report/status DTOs including: compact step list, banner escalation markers, dedicated setup-screen reasons, mode availability map, and ready-toast enable/disable flag. Add model lifecycle IPC channel constants for get-state, subscribe updates, start-check, retry, change-path, copy-report, and download confirmation actions.</action>
  <verify>npm run build</verify>
  <done>Shared lifecycle contracts compile and include all locked startup/download/recovery interaction states needed by main, preload, and renderer.</done>
</task>

<task type="auto">
  <name>Task 2: Implement ModelLifecycleService with locked startup and retry behavior</name>
  <files>src/main/model-lifecycle/model-lifecycle-service.ts, src/main/model-lifecycle/model-lifecycle-service.test.ts</files>
  <action>Implement a main-process `ModelLifecycleService` as source of truth. It should run startup checks, classify trivial vs non-trivial issues, escalate from silent checks to visible banner at 3000ms, require dedicated readiness/setup state for true model/path problems, and orchestrate bundle download with one pre-download confirmation gate. Apply retry policy: baseline 2 automatic retries, expand only for transient network-class failures, never expand for deterministic checksum mismatch. Persist diagnostics report and expose recovery actions (`retry`, `change path`, `copy diagnostics`) plus mode-specific degradation rules from locked decisions.</action>
  <verify>npm run test -- src/main/model-lifecycle/model-lifecycle-service.test.ts</verify>
  <done>Service emits deterministic lifecycle snapshots and transitions covering healthy startup, partial degradation, auto-retry exhaustion, and recovery action states.</done>
</task>

<task type="auto">
  <name>Task 3: Wire lifecycle service through IPC, preload bridge, and main bootstrap</name>
  <files>src/main/ipc/model-lifecycle-controller.ts, src/main/ipc/model-lifecycle-controller.test.ts, src/preload/model-lifecycle-bridge.ts, src/preload/model-lifecycle-bridge.test.ts, src/preload/index.ts, src/main/index.ts</files>
  <action>Add model lifecycle controller registration in main bootstrap and expose typed methods/events through preload `window.scribeValet`. Validate incoming/outgoing payloads in preload bridge, mirror existing runtime-controller pattern, and keep file operations in main process only. Ensure boot wiring initializes lifecycle checks early enough to drive readiness UI before normal mode screens mount.</action>
  <verify>npm run test -- src/main/ipc/model-lifecycle-controller.test.ts src/preload/model-lifecycle-bridge.test.ts && npm run build</verify>
  <done>Renderer can request lifecycle state, subscribe to updates, trigger retry/path/report actions, and receive startup readiness snapshots sourced from main service.</done>
</task>

</tasks>

<verification>
Run service, IPC, and preload tests; then run `npm run build` to confirm process-boundary contracts compile after new channel and bridge wiring.
</verification>

<success_criteria>
Startup readiness and recovery orchestration are fully wired from main service to renderer bridge, with locked escalation and retry defaults enforced in code.
</success_criteria>

<output>
After completion, create `.planning/phases/02-model-and-storage-lifecycle/02-model-and-storage-lifecycle-03-SUMMARY.md`
</output>
