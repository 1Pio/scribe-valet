---
phase: 02-model-and-storage-lifecycle
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/shared/types/model-lifecycle.ts
  - src/shared/protocol/ipc-envelope.ts
  - src/main/model-lifecycle/model-lifecycle-service.ts
  - src/main/model-lifecycle/model-lifecycle-service.test.ts
autonomous: true
must_haves:
  truths:
    - "At startup, readiness state is computed in main process and exposed to renderer with live updates."
    - "If model types are partially unavailable, capabilities degrade by mode (Assistant blocked, Dictation available when STT is healthy with raw-output notice)."
    - "Download/verification failures auto-retry safely and then expose explicit recovery actions with diagnostics."
  artifacts:
    - path: "src/main/model-lifecycle/model-lifecycle-service.ts"
      provides: "Main-process source-of-truth startup checks, install orchestration, and retry policy"
    - path: "src/shared/types/model-lifecycle.ts"
      provides: "Shared DTOs for startup steps, readiness reports, and mode availability"
  key_links:
    - from: "src/main/model-lifecycle/model-lifecycle-service.ts"
      to: "src/main/model-lifecycle/artifact-installer.ts"
      via: "orchestrate missing artifact install and verification"
      pattern: "install|verify|artifact"
    - from: "src/main/model-lifecycle/model-lifecycle-service.ts"
      to: "src/main/storage/storage-paths.ts"
      via: "resolve active model path before readiness checks"
      pattern: "storage|path"
---

<objective>
Create the runtime orchestration core that computes startup/model lifecycle state in main process.

Purpose: Satisfy MODL-01 and MODL-02 behavior with deterministic readiness checks, download/retry orchestration, and shared contracts for downstream IPC wiring.
Output: Shared lifecycle DTO/channel contracts and a tested `ModelLifecycleService` in main process.
</objective>

<execution_context>
@C:/Users/aaron/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/aaron/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-model-and-storage-lifecycle/02-CONTEXT.md
@.planning/phases/02-model-and-storage-lifecycle/02-RESEARCH.md
@src/main/ipc/runtime-controller.ts
@src/preload/runtime-status-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define shared lifecycle state model and IPC channels</name>
  <files>src/shared/types/model-lifecycle.ts, src/shared/protocol/ipc-envelope.ts</files>
  <action>Add typed readiness/checklist/report/status DTOs including: compact step list, banner escalation markers, dedicated setup-screen reasons, mode availability map, and ready-toast enable/disable flag. Add model lifecycle IPC channel constants for get-state, subscribe updates, start-check, retry, change-path, copy-report, and download confirmation actions.</action>
  <verify>npm run build</verify>
  <done>Shared lifecycle contracts compile and include all locked startup/download/recovery interaction states needed by main, preload, and renderer.</done>
</task>

<task type="auto">
  <name>Task 2: Implement ModelLifecycleService with locked startup and retry behavior</name>
  <files>src/main/model-lifecycle/model-lifecycle-service.ts, src/main/model-lifecycle/model-lifecycle-service.test.ts</files>
  <action>Implement a main-process `ModelLifecycleService` as source of truth. It should run startup checks, classify trivial vs non-trivial issues, escalate from silent checks to visible banner at 3000ms, require dedicated readiness/setup state for true model/path problems, and orchestrate bundle download with one pre-download confirmation gate. Apply retry policy: baseline 2 automatic retries, expand only for transient network-class failures, never expand for deterministic checksum mismatch. Persist diagnostics report and expose recovery actions (`retry`, `change path`, `copy diagnostics`) plus mode-specific degradation rules from locked decisions.</action>
  <verify>npm run test -- src/main/model-lifecycle/model-lifecycle-service.test.ts</verify>
  <done>Service emits deterministic lifecycle snapshots and transitions covering healthy startup, partial degradation, auto-retry exhaustion, and recovery action states.</done>
</task>

</tasks>

<verification>
Run `npm run test -- src/main/model-lifecycle/model-lifecycle-service.test.ts` and `npm run build` to confirm lifecycle orchestration compiles and emits locked state transitions.
</verification>

<success_criteria>
Main-process lifecycle orchestration is complete and test-covered, with locked escalation and retry defaults ready for IPC/preload wiring in the next plan.
</success_criteria>

<output>
After completion, create `.planning/phases/02-model-and-storage-lifecycle/02-model-and-storage-lifecycle-03-SUMMARY.md`
</output>
